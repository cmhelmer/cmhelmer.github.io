{%- comment -%}

Feed layout

Generates feed for site or current collection
Based on feed.xml of "jekyll-feed" plugin by Ben Balter

Ignore any passed in content

{%- endcomment -%}

<?xml version="1.0" encoding="utf-8"?>
{%- if page.xsl -%}
<?xml-stylesheet type="text/xml" href="{{ '/feed.xslt.xml' | absolute_url }}"?>
{%- endif -%}
<feed xmlns="http://www.w3.org/2005/Atom" {%- if site.lang -%}xml:lang="{{ site.lang }}"{%- endif -%}>
  <generator uri="https://jekyllrb.com/" version="{{ jekyll.version }}">Jekyll</generator>
  <link href="{{ page.url | absolute_url }}" rel="self" type="application/atom+xml" />
  <link href="{{ '/' | absolute_url }}" rel="alternate" type="text/html" {%- if site.lang -%}hreflang="{{ site.lang | default: 'en' }}" {%- endif -%}/>
  <updated>{{ site.time | date_to_xmlschema }}</updated>
  <id>{{ '/' | absolute_url | xml_escape }}</id>

  {%- capture feed_title -%}
    {{- site.title -}}
    {%- if page.title -%}
    {{- " " -}}
    {{ site.title_separator | default: "|" }}
    {{- " " -}}
    {{ page.title }}
    {%- endif -%}
  {%- endcapture -%}
  <title type="html">{{ feed_title | smartify | xml_escape }}</title>

  {%- if site.description -%}
  <subtitle>{{ site.description | xml_escape }}</subtitle>
  {%- endif -%}

  {%- if site.author -%}
  <author>
    <name>{{ site.author.name | default: site.author | xml_escape }}</name>
    {%- if site.author.email or site.email -%}
    <email>{{ site.author.email | default: site.email | xml_escape }}</email>
    {%- endif -%}
    {%- if site.author.uri -%}
    <uri>{{ site.author.uri | xml_escape }}</uri>
    {%- endif -%}
  </author>
  {%- endif -%}

  {%- comment -%} Get list of docs; sort by ID, unless posts {%- endcomment -%}

  {%- if page.collection -%}
	  {%- assign my_docs = site.documents | where: "collection", page.collection -%}
  {%- else -%}
	  {%- assign my_docs = site.documents -%}
  {%- endif -%}

  {%- unless page.collection == "posts" -%}
	  {%- assign my_docs = my_docs | where_exp: "doc", "doc.uid" | sort: "uid", "first" -%}
  {%- endunless -%}

  {%- comment -%} Reverse to show recent first {%- endcomment -%}
  {%- assign my_docs = my_docs | reverse -%}

  {%- for doc in my_docs limit: 10 -%}

  {%- capture doc_title -%}{%- include filter-title.html my_doc=doc -%}{%- endcapture -%}

  {%- capture doc_date -%}{%- include filter-date.html my_doc=doc -%}{%- endcapture -%}

  {%- comment -%} Get featured image (consider adding this as enclosure if we can parse `type`) {%- endcomment -%}

  {%- assign doc_image = doc.image.path | default: doc.image -%}
  {%- assign image_description = doc.image.description -%}
  {%- unless doc_image contains "://" -%}
  {%- assign doc_image = doc_image | absolute_url | xml_escape  -%}
  {%- endunless -%}

  <entry{%- if doc.lang -%}{{ " " }}xml:lang="{{ doc.lang }}"{%- endif -%}>
    <title type="html">{{ doc_title | strip | xml_escape }}</title>
    <link href="{{ doc.url | absolute_url }}" rel="alternate" type="text/html" title="{{ doc_title | xml_escape }}" />
    <published>{{ doc_date | strip | date_to_xmlschema }}</published>
    <updated>{{ doc.updated | default: doc_date | strip | date_to_xmlschema }}</updated>
    <id>{{ doc.url | absolute_url | xml_escape }}</id>
    <content type="html" xml:base="{{ doc.url | absolute_url | xml_escape }}">

    	{%- comment -%} Shoehorn in featured image {%- endcomment -%}
    	{%- if doc_image != empty -%}
    	{%- if image_description != empty -%}
    	<figure><img src="{{ doc_image }}" alt="{{ image_description }}" /><figcaption>{{ image_description }}</figcaption></figure>
    	{%- else -%}
    	<img src="{{ doc_image }}" alt="" />
    	{%- endif -%}
    	{%- endif -%}

		{%- capture doc_content -%}{%- include filter-content.html my_content=doc.content -%}{%- endcapture -%}
		{{ doc_content | strip | xml_escape }}

    </content>

    {%- assign doc_author = doc.author | default: doc.authors.first | default: site.author -%}
    {%- assign doc_author_name = doc_author.name | default: doc_author -%}
    {%- assign doc_author_email = doc_author.email | default: site.email -%}
    {%- assign doc_author_uri = doc_author.uri | default: nil -%}
    <author>
      <name>{{ doc_author_name | default: '' | xml_escape }}</name>
      {%- if doc_author_email != empty -%}
      <email>{{ doc_author_email | xml_escape }}</email>
      {%- endif -%}
      {%- if doc_author_uri -%}
      <uri>{{ doc_author_uri | xml_escape }}</uri>
      {%- endif -%}
    </author>

	{%- if doc.collection != "posts" -%}
    <category term="{{ site.collections[doc.collection].title | default: doc.collection | xml_escape }}" />
    {%- endif -%}

    {%- if doc.category != empty -%}
    <category term="{{ doc.category | xml_escape }}" />
    {%- endif -%}

    {%- for tag in doc.tags -%}
    <category term="{{ tag | xml_escape }}" />
    {%- endfor -%}

	{%- capture doc_excerpt -%}{%- include filter-excerpt.html my_doc=doc -%}{%- endcapture -%}
    <summary type="html">{{ doc_excerpt | xml_escape }}</summary>

    {%- if doc_image != empty -%}
    <media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="{{ doc_image }}" />
    {%- endif -%}
  </entry>
  {%- endfor -%}
</feed>
