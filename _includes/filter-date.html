{%- comment -%}

Filter date

Use date if not site build time or time set to 0
(Collection documents don't have dates by default)
(Jekyll defaults to site build time)
(Posts have date but no time unless set in metadata)
Parse datetime from ID, because we can, and to avoid redundant metadata
Format date to ISO8601 standard for feeds and html "datetime" attribute

- Pass in full document (page)
- Assume 12-digit uid string (YYYYMMDDhhmm or %Y%m%d%H%M)

TODO:
- Remove date_to_xmlschema from other places
- Add timezone from config

{%- endcomment -%}

{%- assign my_doc = include.my_doc -%}

{%- if my_doc.uid != nil -%}

	{%- comment -%} Parse datetime from uid {%- endcomment -%}

	{%- assign doc_uid = my_doc.uid | strip -%}

	{%- assign uid_year   = doc_uid | slice:  0, 4 -%}
	{%- assign uid_month  = doc_uid | slice:  4, 2 -%}
	{%- assign uid_day    = doc_uid | slice:  6, 2 -%}
	{%- assign uid_hour   = doc_uid | slice:  8, 2 -%}
	{%- assign uid_minute = doc_uid | slice: 10, 2 -%}

	{%- capture uid_datetime -%}
		{{ uid_year }}-{{ uid_month }}-{{ uid_day }} {{ uid_hour }}:{{ uid_minute }}
	{%- endcapture -%}
	{%- assign uid_datetime = uid_datetime | strip -%}

	{%- comment -%} Compare date and parsed uid date {%- endcomment -%}

	{%- assign uid_date = uid_datetime | date: "%Y-%m-%d" -%}
	{%- assign uid_time = uid_datetime | date: "%H:%M" -%}
	{%- assign my_date = my_doc.date | date: "%Y-%m-%d" -%}
	{%- assign my_time = my_doc.date | date: "%H:%M" -%}

	{%- comment -%} Use uid datetime for docs without dates (default site build time) {%- endcomment -%}

	{%- if my_doc.date == site.time -%}

		{%- assign doc_datetime = uid_datetime -%}

	{%- comment -%}
	Use uid time for posts without time
	(Implicit date from filename or explicit date in metadata without time)
	Comparing dates for edge case of explicitly set date different from uid with time of midnight
	{%- endcomment -%}

	{%- elsif my_time == "00:00" and my_date == uid_date -%}
	
		{%- assign doc_datetime = my_date | append: " " | append: uid_time -%}

	{%- else -%}
	
		{%- assign doc_datetime = my_doc.date -%}

	{%- endif -%}

{%- else -%}

	{%- assign doc_datetime = my_doc.date -%}

{%- endif -%}

{{- doc_datetime | date_to_xmlschema -}}
