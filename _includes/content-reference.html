{%- comment -%}

Include reference if present in metadata
Gets reference metadata of another document by uid
- Pass in reference metadata

{%- endcomment -%}

{%- assign my_ref = include.my_ref -%}

{%- if my_ref != nil -%}

	{%- comment -%} Try to get referenced reference by uid {%- endcomment -%}

	{%- assign ref_uid = my_ref.uid | default: my_ref -%}
	{%- assign ref_ref = "" -%}
	{%- if ref_uid != nil -%}

		{%- assign ref_doc = site.documents | where: "uid", ref_uid | where_exp: "doc", "doc.reference != nil" | first -%}
		{%- assign ref_ref = ref_doc.reference -%}

	{%- endif -%}

	{%- comment -%} Let this doc's metadata override referenced doc {%- endcomment -%}

	{%- assign ref_title       = my_ref.title       | default: ref_ref.title       | strip -%}
	{%- assign ref_author      = my_ref.author      | default: ref_ref.author      | strip -%}
	{%- assign ref_publication = my_ref.publication | default: ref_ref.publication | strip -%}
	{%- assign ref_date        = my_ref.date        | default: ref_ref.date        | strip -%}
	{%- assign ref_accessed    = my_ref.accessed    | default: ref_ref.accessed    | strip -%}
	{%- assign ref_pages       = my_ref.pages       | default: ref_ref.pages       | strip -%}
	{%- assign ref_url         = my_ref.url         | default: ref_ref.url         | strip -%}

	{%- comment -%} Informal bibliographic reference {%- endcomment -%}

	{%- capture doc_ref -%}

		<cite class="ref">
		
		{%- if ref_author != "" -%}
			<span class="ref-author">{{ ref_author }}</span>{{", "}}
		{%- endif -%}

		“<span class="ref-title">{{ ref_title | default: ref }}</span>{%- if ref_publication != "" or ref_pages != "" -%},{%- endif -%}{{"”"}}

		{%- if ref_publication != "" -%}
			{{" "}}<i class="ref-publication">{{ ref_publication }}</i>
		{%- endif -%}

		{%- if ref_date != "" -%}
			{{" ("}}<time class="ref-date" datetime="{{ ref_date | date_to_xmlschema }}">{{ ref_date | date: site.date_format }}</time>{{") "}}{%- if ref_pages != "" -%},{%- endif -%}
		{%- endif -%}

		{%- if ref_pages != "" -%}
			{{" "}}<span class="ref-pages">{{ ref_pages }}</span>
		{%- endif -%}

		</cite>

	{%- endcapture -%}

	{%- comment -%}
	
	Add link and icons
	Pin for links (posts), bookmark for quotes (collection notes)
	Icons can be set in CSS, but inline (to external source) sends them out with content (ex. in RSS feed)
	
	{%- endcomment -%}

	{%- capture doc_ref -%}

		{%- if ref_url != "" -%}

			<a href="{{ ref_url | escape }}" rel="external nofollow noopener"><svg class="icon icon-pin" width="16" height="16" role="presentation"><use xlink:href="{{ '/assets/img/icons.svg#pin' | absolute_url }}"></use></svg>{{ doc_ref }}</a>

		{%- else -%}

			<svg class="icon icon-bookmark" width="16" height="16" role="presentation"><use xlink:href="{{ '/assets/img/icons.svg#bookmark' | absolute_url }}"></use></svg>{{ doc_ref }}

		{%- endif -%}

	{%- endcapture -%}

<p class="doc-ref">{{ doc_ref }}</p>

{%- endif -%}
