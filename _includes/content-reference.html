{%- comment -%}

Include reference if present in metadata
Gets reference metadata of another document by uid

TODO:
- Stop assuming that references are links/bookmarks if they're not linked to another note by ref.uid or just ref

{%- endcomment -%}

{%- assign my_doc = include.my_doc -%}

{%- if my_doc.reference -%}

	{%- assign ref = my_doc.reference -%}

	{%- comment -%} Try to get referenced reference by uid {%- endcomment -%}

	{%- assign ref_uid = ref.uid | default: ref -%}
	{%- assign ref_ref = "" -%}
	{%- if ref_uid != nil -%}

		{%- assign ref_doc = site.documents | where_exp: "doc", "doc.uid == ref_uid" | where_exp: "doc", "doc.reference != nil" | first -%}
		{%- assign ref_ref = ref_doc.reference -%}

	{%- endif -%}

	{%- comment -%} Let this doc's metadata override referenced doc {%- endcomment -%}

	{%- assign ref_title       = ref.title       | default: ref_ref.title       | strip -%}
	{%- assign ref_author      = ref.author      | default: ref_ref.author      | strip -%}
	{%- assign ref_publication = ref.publication | default: ref_ref.publication | strip -%}
	{%- assign ref_date        = ref.date        | default: ref_ref.date        | strip -%}
	{%- assign ref_accessed    = ref.accessed    | default: ref_ref.accessed    | strip -%}
	{%- assign ref_pages       = ref.pages       | default: ref_ref.pages       | strip -%}
	{%- assign ref_url         = ref.url         | default: ref_ref.url         | strip -%}

	{%- comment -%} Informal bibliographic reference {%- endcomment -%}

	{%- capture doc_ref -%}

		<svg class="icon icon-bookmark" width="16" height="16" role="presentation"><use xlink:href="{{ '/assets/img/icons.svg#bookmark' | absolute_url }}"></use></svg><cite class="ref">
		
		{%- if ref_author != "" -%}
			<span class="ref-author">{{ ref_author }}</span>{{", "}}
		{%- endif -%}

		“<span class="ref-title">{{ ref_title | default: ref }}</span>{%- if ref_publication != "" or ref_pages != "" -%},{%- endif -%}{{"”"}}

		{%- if ref_publication != "" -%}
			{{" "}}<i class="ref-publication">{{ ref_publication }}</i>
		{%- endif -%}

		{%- if ref_date != "" -%}
			{{" ("}}<time class="ref-date" datetime="{{ ref_date | date_to_xmlschema }}">{{ ref_date | date: site.date_format }}</time>{{") "}}{%- if ref_pages != "" -%},{%- endif -%}
		{%- endif -%}

		{%- if ref_pages != "" -%}
			{{" "}}<span class="ref-pages">{{ ref_pages }}</span>
		{%- endif -%}

		</cite>

	{%- endcapture -%}

	{%- comment -%} Add link {%- endcomment -%}

	{%- capture doc_ref -%}

		{%- if ref_url != "" -%}
			<a href="{{ ref.url | escape }}" rel="external nofollow noopener">{{ doc_ref }}</a>
		{%- else -%}
			{{ doc_ref }}
		{%- endif -%}

	{%- endcapture -%}

<p class="doc-ref">{{ doc_ref | strip }}</p>

{%- endif -%}
