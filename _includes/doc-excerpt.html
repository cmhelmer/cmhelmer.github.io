{%- comment -%}

Include document excerpt

Roll our own excerpt in order to use custom metadata and content filters
Prefer "description" set in metadata (not "excerpt", which is set by Jekyll and not useful to us)

- Pass in document (optional)

{%- endcomment -%}

{%- if include.doc -%}
	{%- assign doc = include.doc -%}
{%- else -%}
	{%- assign doc = page -%}
{%- endif -%}

{%- capture doc_excerpt -%}

{%- if doc.description != nil -%}

	{{ doc.description }}

{%- else -%}

	{%- comment -%} Render and strip {%- endcomment -%}
	{%- assign plain_content = doc.content | markdownify | strip_html | strip -%}
	
	{%- comment -%} Trim to string before first separator {%- endcomment -%}
	{%- assign plain_excerpt = plain_content | split: site.excerpt_separator | first -%}
	
	{%- comment -%} Filter as content to render custom markdown {%- endcomment -%}
	{%- include doc-content.html doc_content=plain_excerpt -%}
	
{%- endif -%}

{%- endcapture -%}

{%- assign excerpt_length = site.excerpt_length | default: include.excerpt_length | default: 140 -%}

{{- doc_excerpt | strip_html | normalize_whitespace | strip | truncate: excerpt_length -}}
